<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Manage My Children - CampSphere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="/css/modern-style.css" rel="stylesheet">
    <link href="/css/navbar.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gray);
        }
        
        .page-header {
            background: var(--gradient-primary);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0;
        }
        
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        
        .success-modal.show {
            display: flex;
        }
        
        .success-modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3rem;
            animation: checkBounce 0.6s ease;
        }
        
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        
        .error-modal.show {
            display: flex;
        }
        
        .error-modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 3rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes checkBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

<!-- Success Modal -->
<div id="successModal" class="success-modal">
    <div class="success-modal-content">
        <div class="success-icon">âœ“</div>
        <h3 class="fw-bold mb-2" style="color: #059669;">Child Added Successfully!</h3>
        <p class="text-muted mb-4" id="successMessage">Your child has been added to your account.</p>
        <button onclick="closeSuccessModal()" class="btn btn-modern-primary w-100 py-3">
            Perfect! âœ¨
        </button>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="error-modal">
    <div class="error-modal-content">
        <div class="error-icon">âœ•</div>
        <h3 class="fw-bold mb-2" style="color: #dc2626;">Operation Failed</h3>
        <p class="text-muted mb-4" id="errorMessage">An error occurred.</p>
        <button onclick="closeErrorModal()" class="btn btn-modern-primary w-100 py-3">
            Try Again
        </button>
    </div>
</div>

<!-- Modern Navbar -->
<div id="navbar-container"></div>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>ðŸ‘¶ My Children</h1>
        <p class="mb-0 opacity-90">Manage your children's profiles and information</p>
    </div>
</div>

<!-- Main Content -->
<div class="container pb-5">
    <!-- Children Table -->
    <div class="modern-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold mb-0">Your Children</h3>
            <span class="modern-badge modern-badge-info" id="childCount">0 Children</span>
        </div>
        
        <div class="modern-table">
            <table class="table mb-0" id="childrenTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Date of Birth</th>
                        <th>Age</th>
                        <th>School</th>
                        <th>Medical Info</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody id="childTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <div class="py-3">
                                <div class="mb-3" style="font-size: 3rem;">ðŸ‘¶</div>
                                <p class="mb-0">No children found. Add your first child below!</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Child Form -->
    <div class="modern-card">
        <div class="d-flex align-items-center mb-4">
            <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--gradient-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 1rem;">
                âž•
            </div>
            <div>
                <h3 class="fw-bold mb-0">Add a New Child</h3>
                <p class="text-muted mb-0">Fill in your child's information</p>
            </div>
        </div>
        
        <form id="childForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="modern-form-label">Child Name *</label>
                        <input type="text" id="name" class="modern-form-control" placeholder="Enter full name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="modern-form-label">Child Email *</label>
                        <input type="email" id="email" class="modern-form-control" placeholder="child@example.com" required>
                    </div>
                    <div class="col-md-6">
                        <label for="password" class="modern-form-label">Password *</label>
                        <input type="password" id="password" class="modern-form-control" placeholder="Create password" required>
                    </div>
                    <div class="col-md-6">
                        <label for="dob" class="modern-form-label">Date of Birth *</label>
                        <input type="date" id="dob" class="modern-form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label for="school" class="modern-form-label">School *</label>
                        <input type="text" id="school" class="modern-form-control" placeholder="School name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="medical" class="modern-form-label">Medical Info</label>
                        <input type="text" id="medical" class="modern-form-control" placeholder="Allergies, conditions, etc.">
                    </div>
                    <div class="col-12 mt-4">
                        <button class="btn btn-modern-primary w-100 py-3" type="submit">
                            âž• Add Child
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer class="modern-footer">
    <div class="container text-center">
        <small>Â© 2025 CampSphere. All rights reserved.</small>
    </div>
</footer>

<script>
    const parentId = +localStorage.getItem("parentId");
    if (!parentId) location.href = "/parent-login.html";
    
    function showSuccessModal(message) {
        document.getElementById("successMessage").textContent = message;
        document.getElementById("successModal").classList.add("show");
    }
    
    function showErrorModal(message) {
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorModal").classList.add("show");
    }
    
    function closeSuccessModal() {
        document.getElementById("successModal").classList.remove("show");
    }
    
    function closeErrorModal() {
        document.getElementById("errorModal").classList.remove("show");
    }

    // Calculate age from date of birth
    function calculateAge(dateOfBirth) {
      const today = new Date();
      const birthDate = new Date(dateOfBirth);
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    async function loadChildren() {
      try {
        const res = await fetch("/api/children");
        const all = await res.json();
        const mine = all.filter(c => c.parentId === parentId);
        
        const tbody = document.getElementById("childTableBody");
        const countBadge = document.getElementById("childCount");
        tbody.innerHTML = "";
        
        // Update count badge
        countBadge.textContent = mine.length === 1 ? '1 Child' : `${mine.length} Children`;
        
        if (mine.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-5">
            <div class="py-3">
              <div class="mb-3" style="font-size: 3rem;">ðŸ‘¶</div>
              <p class="mb-0">No children found. Add your first child below!</p>
            </div>
          </td></tr>`;
          return;
        }
        
        mine.forEach((c, index) => {
          const row = document.createElement("tr");
          const age = calculateAge(c.dateOfBirth);
          
          row.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td><strong>${c.name}</strong></td>
            <td>${c.dateOfBirth}</td>
            <td><span class="modern-badge modern-badge-info">${age} years</span></td>
            <td>${c.school}</td>
            <td>${c.medicalInfo || '<span class="text-muted">None</span>'}</td>
            <td>${c.email || '<span class="text-muted">N/A</span>'}</td>
          `;
          
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading children:", err);
        showErrorModal("Failed to load children. Please refresh the page or try again later.");
      }
    }

    document.getElementById("childForm").addEventListener("submit", async e => {
      e.preventDefault();
      
      const payload = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        dateOfBirth: document.getElementById("dob").value,
        school: document.getElementById("school").value,
        medicalInfo: document.getElementById("medical").value,
        parent: { id: parentId }
      };

      try {
        const res = await fetch("/api/children", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          const childName = document.getElementById("name").value;
          showSuccessModal(`${childName} has been successfully added to your account!`);
          e.target.reset();
          await loadChildren();
        } else {
          const errorText = await res.text();
          showErrorModal(errorText || "Failed to add child. Please check the information and try again.");
        }
      } catch (err) {
        console.error("Error adding child:", err);
        showErrorModal("Network error. Please check your connection and try again.");
      }
    });

    loadChildren();
</script>
<script src="/js/navbar.js"></script>
</body>
</html>
